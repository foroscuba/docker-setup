name: xenforo

services:
  php:
    container_name: xenforo-php
    build: .
    restart: unless-stopped
    ports:
      - "18580:8080"
    volumes:
      - ./web:/var/www/html
      - ./nginx/xenforo.conf:/etc/nginx/site-opts.d/xenforo.conf:ro
    environment:
      PHP_MEMORY_LIMIT: "512M"
      PHP_MAX_EXECUTION_TIME: "120"
      PHP_MAX_INPUT_TIME: "120"
      PHP_MAX_INPUT_VARS: "10000"
      PHP_UPLOAD_MAX_FILE_SIZE: "256M"
      PHP_POST_MAX_SIZE: "256M"
      PHP_OPCACHE_ENABLE: "1"
      PHP_OPCACHE_MEMORY_CONSUMPTION: "256"
      PHP_OPCACHE_MAX_ACCELERATED_FILES: "20000"
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "0"
      PHP_DISPLAY_ERRORS: "Off"
      PHP_SESSION_COOKIE_SECURE: "1"
      PHP_SESSION_COOKIE_HTTPONLY: "1"
      SSL_MODE: "off"
      TZ: "America/New_York"
    # Pin to NUMA node 0 (physical cores only)
    cpuset: "0-17"
    mem_limit: 4g
    depends_on:
      - mariadb
      - redis
      - elasticsearch

  mariadb:
    container_name: xenforo-mariadb
    image: mariadb:11.8
    restart: unless-stopped
    ports:
      - "13306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./mariadb/custom.cnf:/etc/mysql/conf.d/custom.cnf:ro
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      TZ: "America/New_York"
    # Pin to NUMA node 0 - 8 physical cores for DB
    cpuset: "0-7"
    mem_limit: 16g

  redis:
    container_name: xenforo-redis
    image: redis:alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf --requirepass ${REDIS_PASSWORD}
    # Pin to NUMA node 0
    cpuset: "8-9"
    mem_limit: 2g

  elasticsearch:
    container_name: xenforo-elasticsearch
    image: elasticsearch:8.17.0
    restart: unless-stopped
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
    # Pin to NUMA node 0
    cpuset: "10-13"
    mem_limit: 4g

volumes:
  mariadb_data:
  redis_data:
  elasticsearch_data:
